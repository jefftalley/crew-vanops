<!DOCTYPE html>
<html>
  <head>
    <style type="text/css">
      html, body, #map-canvas { height: 100%; margin: 0; padding: 0;}
    </style>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?"> </script>
    <script src="js/sockjs-0.3.4.js"></script>
    <script src="js/stomp.js"></script>
    <script type="text/javascript">
    var stompClient = null;
	var map;
	var mapOptions;
	var planeMarkers = [];
	var flightArr = [];
	var vanMarker = null;
	var flightNumbers = []; 
	var flightInfoWindow = [];
	var planeInfoWindow;
	var planeImage = {
			url: 'http://upload.wikimedia.org/wikipedia/commons/0/01/Airplane_silhouette_45degree_angle.svg',
			size: new google.maps.Size(50, 50),
			origin: new google.maps.Point(0,0),
			anchor: new google.maps.Point(0, 32),
			scaledSize: new google.maps.Size(35, 35)
		};
	var vanImage = {
			url: 'http://cdn.flaticon.com/png/256/26875.png',
			size: new google.maps.Size(20, 20),
			origin: new google.maps.Point(0,0),
			anchor: new google.maps.Point(0, 32),
			scaledSize: new google.maps.Size(15, 15)
	}
	
        function setConnected(connected) {
            document.getElementById('connect').disabled = connected;
            document.getElementById('disconnect').disabled = !connected;
        }

        function connect() {
            var socket = new SockJS('/requests');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function(frame) {
                setConnected(true);
                console.log('Connected: ' + frame);
                stompClient.subscribe('/topic/messages', function(message){
                	var messageBody = JSON.parse(message.body);
					if (messageBody.messageType === 'flightUpdate') {
						processFlight(messageBody.content);
					}
					/*
					if (messageBody.messageType === 'vanUpdate') {
						processVan(messageBody.content);
					}
					*/
                });
                stompClient.send("/app/init", {}, '');
            });
        }
	
        function disconnect() {
            if (stompClient != null) {
                stompClient.disconnect();
            }
            setConnected(false);
            console.log("Disconnected");
        }
        
        function pickUp() {
        	stompClient.send("/app/pickUp", {}, '');
        }
    
      function initialize() {   	  
        mapOptions = {
          center: { lat: 38.174697, lng: -85.739562},
          zoom: 17
        };
        map = new google.maps.Map(document.getElementById('map-canvas'),
            mapOptions);
        
        flightArr = [{"scheduleDepartureTime":"2015-03-23T20:19:00",
    							"flightNumber":"UPS1234",
    							"tailNumber":"N1234UP",
    							"origin":"SDF",
    							"destination":"LAX",
    							"parkingPosition":"S4",
    							"latitude":"38.17234463",
    							"longitude":"-85.73675752"}, {} ];
		vanArr = [];
		flightNumber = [];      
		
		connect();
      }
      
      function processFlight(flight) {
      
	      	var exists = false;
	      	
	      	for(i = 0; i < flightNumbers.length; i++) {
	      		if(flight.flightNumber == flightNumbers[i]) {
	      			// Update Flight
	      			planeMarkers[i].setPosition()
	      			
	      			exists = true;
	      		} 
	      	}
	   		if (exists == false) {
	   		// Create New
	       		flightNumbers.push(flight.flightNumber);
	       		
	       		var planeText = flight.scheduleDepartureTime + "<br/>"
	   			+ flight.flightNumber + "<br/>"
	 				+ flight.tailNumber + "<br/>"
	 				+ flight.origin + "<br/>"
	 				+ flight.destination + "<br/>"
	 				+ flight.parkingPosition + "<br/>"
	 				+ flight.latitude + "<br/>"
	 				+ flight.longitude + "<br/>"
	 				+ "Crew:"
	 				+ "\t" + flight.crews.gemsId + "<br/>"
	 				+ "\t" + flight.crews.firstName + "<br/>"
	 				+ "\t" + flight.crews.lastName + "<br/>"
	 				+ "\t" + flight.crews.position + "<br/>"
	 				+ "\t" + flight.crews.status + "<br/>";
	 			var myLatLng = new google.maps.LatLng(flight.latitude, flight.longitude);
	 			
	 			var curPlaneMarker = planeMarkers.push( new google.maps.Marker({
	 			     position: myLatLng,
	 				 map: map,
	 				 icon: planeImage
	 			}));
	 			
	 			planeInfoWindow = new google.maps.InfoWindow({
	 					content: planeText,
	 					maxWidth: 250
	 			});
	 			
	 			google.maps.event.addListener(curPlaneMarker, 'click', function() {
	 				planeInfoWindow.open(map, curPlaneMarker);
	 			});
	    	}
       }
       
       function processVan(van) {
      		if(vanMarker != null) {
      			// Update Van
      			
      		} else {
      			// Create Van
				var myLatLng = new google.maps.LatLng(van.latitude, van.longitude);
	 			
	 			vanMarker.push( new google.maps.Marker({
	 			     position: myLatLng,
	 				 map: map,
	 				 icon: vanImage
	 			}));
	 			
	 			vanInfoWindow = new google.maps.InfoWindow({
	 					content: vanText,
	 					maxWidth: 250
	 			});
	 			
	 			google.maps.event.addListener(vanMarker, 'click', function() {
	 				vanInfoWindow.open(map, vanMarker);
	 			});	
      		}
      	}
       
   	google.maps.event.addDomListener(window, 'load', initialize);
    </script>
  </head>
  <body>
  <noscript><h2 style="color: #ff0000">Seems your browser doesn't support Javascript! Websocket relies on Javascript being enabled. Please enable
    Javascript and reload this page!</h2></noscript>
    <div>
        <button id="connect" onclick="pickUp();">Pick Up Demo</button>
        <button id="disconnect" disabled="disabled" onclick="disconnect();">Disconnect</button>
    </div>
	<div id="map-canvas"></div>
  </body>
</html>