<!DOCTYPE html>
<html>
  <head>
    <style type="text/css">
      html, body, #map-canvas { height: 100%; margin: 0; padding: 0;}
    </style>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?"> </script>
    <script src="js/sockjs-0.3.4.js"></script>
    <script src="js/stomp.js"></script>
    <script type="text/javascript">
    var stompClient = null;
	var map;
	var mapOptions;
	var planeMarkers = [];
	var vanMarker = null;
	var flightNumbers = []; 
	var flightInfoWindow = [];
	var planeInfoWindows = [];
	var vanInfoWindow;
	var planeImage = {
			url: 'http://upload.wikimedia.org/wikipedia/commons/0/01/Airplane_silhouette_45degree_angle.svg',
			size: new google.maps.Size(50, 50),
			origin: new google.maps.Point(0,0),
			anchor: new google.maps.Point(0, 0),
			scaledSize: new google.maps.Size(35, 35)
		};
	var vanImage = {
			url: 'http://cdn.flaticon.com/png/256/26875.png',
			size: new google.maps.Size(20, 20),
			origin: new google.maps.Point(0,0),
			anchor: new google.maps.Point(0, 0),
			scaledSize: new google.maps.Size(15, 15)
	}

        function connect() {
            var socket = new SockJS('/requests');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function(frame) {
                console.log('Connected: ' + frame);
                stompClient.subscribe('/topic/messages', function(message){
                	var messageBody = JSON.parse(message.body);
					if (messageBody.messageType === 'flightUpdate') {
						processFlight(messageBody.content);
					}
					if (messageBody.messageType === 'vanUpdate') {
						processVan(messageBody.content);
					}
					
                });
                stompClient.send("/app/init", {}, '');
            });
        }
        
        function pickUp() {
        	stompClient.send("/app/pickUp", {}, '');
        }
    
      function initialize() {   	  
        mapOptions = {
          center: { lat: 38.174697, lng: -85.739562},
          zoom: 17
        };
        map = new google.maps.Map(document.getElementById('map-canvas'),
            mapOptions);     
		
		connect();
      }
      
      function processFlight(flight) {
      
	      	var exists = false;
	      	
	      	for(i = 0; i < flightNumbers.length; i++) {
	      		if(flight.flightNumber == flightNumbers[i]) {
	      			// Update Flight
	      			var newLatLng = new google.maps.LatLng(flight.latitude, flight.longitude);
	      			planeMarkers[i].setPosition(newLatLng);
	      			var planeText = updateFlightInfoText(flight);
	      			planeInfoWindows[i].setContent(planeText);
	      			exists = true;
	      		} 
	      	}
	   		if (exists == false) {
	   		// Create New
	       		flightNumbers.push(flight.flightNumber);
	       		
	       		var planeText = updateFlightInfoText(flight);
	 				
	 			var myLatLng = new google.maps.LatLng(flight.latitude, flight.longitude);
	 			
	 			var curPlaneMarker = new google.maps.Marker({
	 			     position: myLatLng,
	 				 map: map,
	 				 icon: planeImage
	 			});
	 			
	 			planeMarkers.push(curPlaneMarker);
	 			
	 			var curPlaneInfoWindow = new google.maps.InfoWindow({
	 					content: planeText,
	 					maxWidth: 250
	 			});
	 			
	 			var planeInfoWindows.push(curPlaneInfoWindow);
	 			
	 			google.maps.event.addListener(curPlaneMarker, 'click', function() {
	 				planeInfoWindows[curPlaneInfoWindow].open(map, curPlaneMarker]);
	 			});
	    	}
       }
      
      function updateFlightInfoText(flight) {
    	  		var planeText = flight.scheduleDepartureTime + "<br/>"
 				+ "Flight #: " + flight.flightNumber + "<br/>"
				+ "Tail #: " + flight.tailNumber + "<br/>"
				+ "Origin: " + flight.origin + "<br/>"
				+ "Desitination: " +flight.destination + "<br/>"
				+ "Parking Pos.: " + flight.parkingPosition + "<br/>"
				+ "Crew:<br/>";
				
				flight.crews.forEach(function(crewMember) {
					planeText += "\t" + crewMember.gemsId + "<br/>"
	 				+ "\t First Name: " + crewMember.firstName + "<br/>"
	 				+ "\t Last Name:" + crewMember.lastName + "<br/>"
	 				+ "\t Pos.: " + crewMember.position + "<br/>"
	 				+ "\t Status: " + crewMember.status + "<br/>";
				});
				
				return planeText;
      }
       
       function processVan(van) {
      		if(vanMarker != null) {
      			// Update Van
      			var newLatLng = new google.maps.LatLng(van.latitude, van.longitude);
      			vanMarker.setPosition(newLatLng);
      			var vanText = updateVanInfoText(van);
      			vanInfoWindow.setContent(vanText);
      		} else {
      			// Create Van
				var myLatLng = new google.maps.LatLng(van.latitude, van.longitude);
	 			
	 			vanMarker = new google.maps.Marker({
	 			     position: myLatLng,
	 				 map: map,
	 				 icon: vanImage
	 			}));
	 			
	 			vanInfoWindow = new google.maps.InfoWindow({
	 					content: vanText,
	 					maxWidth: 250
	 			});
	 			
	 			google.maps.event.addListener(vanMarker, 'click', function() {
	 				vanInfoWindow.open(map, vanMarker);
	 			});	
      		}
      	}
       
       function updateVanInfoText(van) {
	  		var vanText = van.vanId;
			
			/* forEach(flight.crew, function(crewMember) {
				planeText += "\t" + crewMember.gemsId + "<br/>"
				+ "\t" + crewMember.firstName + "<br/>"
				+ "\t" + crewMember.lastName + "<br/>"
				+ "\t" + crewMember.position + "<br/>"
				+ "\t" + crewMember.status + "<br/>";
			}); */
			
			return vanText;
 		}
       
   	google.maps.event.addDomListener(window, 'load', initialize);
    </script>
  </head>
  <body>
  <noscript><h2 style="color: #ff0000">Seems your browser doesn't support Javascript! Websocket relies on Javascript being enabled. Please enable
    Javascript and reload this page!</h2></noscript>
    <div>
        <button id="connect" onclick="pickUp();">Pick Up Demo</button>
        <button id="disconnect" disabled="disabled" onclick="disconnect();">Disconnect</button>
    </div>
	<div id="map-canvas"></div>
  </body>
</html>